// js/costos.js
import { db } from "./firebase.js";
import {
  collection,
  getDocs,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ============================================================
   DOM
============================================================ */
const tbody = document.getElementById("lineasCostos");
const btnAgregar = document.getElementById("btnAgregarLinea");
const btnAgregarCostosBase = document.getElementById("btnAgregarCostosBase");
const costoTotalEl = document.getElementById("costoTotal");
const btnGuardarReceta = document.getElementById("btnGuardarReceta");
const nombreProductoInput = document.getElementById("nombreProducto");

/* ============================================================
   STATE
============================================================ */
let insumos = {};
let insumosOrdenados = [];
let lineas = [];

/* ============================================================
   COSTOS BASE PIXEL
============================================================ */
const COSTOS_BASE_PIXEL = [
  { nombre: "Tinta y electricidad", costo: 200 },
  { nombre: "Tiempo y diseño", costo: 200 }
];

/* ============================================================
   HELPERS
============================================================ */
const toNumber = v => Number.isFinite(+v) ? +v : 0;

function getCostoUnitarioReal(ins) {
  const cantPack = toNumber(ins.cantidadPaquete);
  const costoPack = toNumber(ins.costoPaquete);
  const unit = toNumber(ins.costoUnitario);

  if (costoPack > 0 && cantPack > 0) return costoPack / cantPack;
  return unit;
}

function recalcularTotal() {
  let total = 0;

  lineas.forEach(l => {
    if (l.tipo === "base") {
      total += l.costo;
    } else {
      const ins = insumos[l.insumoId];
      if (!ins) return;
      total += l.cantidad * getCostoUnitarioReal(ins);
    }
  });

  costoTotalEl.textContent = total.toFixed(2);
}

/* ============================================================
   CARGAR INSUMOS
============================================================ */
async function cargarInsumos() {
  const snap = await getDocs(collection(db, "insumos"));
  snap.forEach(d => insumos[d.id] = d.data());

  insumosOrdenados = Object.keys(insumos).sort((a, b) =>
    insumos[a].nombre.localeCompare(insumos[b].nombre, "es", { sensitivity: "base" })
  );
}

/* ============================================================
   AGREGAR INSUMO
============================================================ */
btnAgregar.onclick = () => {
  if (!insumosOrdenados.length) return alert("No hay insumos cargados.");

  lineas.push({
    tipo: "insumo",
    insumoId: insumosOrdenados[0],
    cantidad: 1
  });

  render();
};

/* ============================================================
   AGREGAR COSTOS BASE
============================================================ */
btnAgregarCostosBase.onclick = () => {
  COSTOS_BASE_PIXEL.forEach(base => {
    if (!lineas.some(l => l.tipo === "base" && l.nombre === base.nombre)) {
      lineas.push({ tipo: "base", ...base });
    }
  });
  render();
};

/* ============================================================
   RENDER
============================================================ */
function render() {
  tbody.innerHTML = "";

  lineas.forEach((l, index) => {

    if (l.tipo === "base") {
      tbody.innerHTML += `
        <tr style="background: rgba(255,159,67,0.15);">
          <td>⚡ ${l.nombre}<div class="hint">Costo fijo</div></td>
          <td>—</td>
          <td>$${l.costo.toFixed(2)}</td>
          <td><button class="btn btn-outline" data-del="${index}">✖</button></td>
        </tr>
      `;
      return;
    }

    const ins = insumos[l.insumoId];
    const unit = getCostoUnitarioReal(ins);
    const subtotal = l.cantidad * unit;

    tbody.innerHTML += `
      <tr>
        <td>
          <input class="buscar-insumo" data-i="${index}" placeholder="Buscar insumo…">
          <select class="selInsumo" data-i="${index}">
            ${insumosOrdenados.map(id =>
              `<option value="${id}" ${id === l.insumoId ? "selected" : ""}>
                ${insumos[id].nombre}
              </option>`
            ).join("")}
          </select>
          <div class="hint">Unit: $${unit.toFixed(2)}</div>
        </td>

        <td>
          <input type="number" class="inpCantidad" data-i="${index}" value="${l.cantidad}">
        </td>

        <td>$${subtotal.toFixed(2)}</td>

        <td><button class="btn btn-outline" data-del="${index}">✖</button></td>
      </tr>
    `;
  });

  bindEvents();
  recalcularTotal();
}

/* ============================================================
   EVENTS
============================================================ */
function bindEvents() {

  // eliminar
  tbody.querySelectorAll("[data-del]").forEach(btn => {
    btn.onclick = () => {
      lineas.splice(btn.dataset.del, 1);
      render();
    };
  });

  // cambio de insumo
  tbody.querySelectorAll(".selInsumo").forEach(sel => {
    sel.onchange = e => {
      lineas[e.target.dataset.i].insumoId = e.target.value;
      recalcularTotal();
    };
  });

  // cantidad (SIN render)
  tbody.querySelectorAll(".inpCantidad").forEach(inp => {
    inp.oninput = e => {
      lineas[e.target.dataset.i].cantidad = toNumber(e.target.value);
      recalcularTotal();
    };
  });

  // buscador (SIN render)
  tbody.querySelectorAll(".buscar-insumo").forEach(input => {
    input.oninput = e => {
      const i = e.target.dataset.i;
      const texto = e.target.value.toLowerCase();
      const select = tbody.querySelector(`.selInsumo[data-i="${i}"]`);

      select.innerHTML = insumosOrdenados
        .filter(id => insumos[id].nombre.toLowerCase().includes(texto))
        .map(id => `<option value="${id}">${insumos[id].nombre}</option>`)
        .join("");

      if (select.options.length) {
        lineas[i].insumoId = select.value;
        recalcularTotal();
      }
    };
  });
}

/* ============================================================
   GUARDAR RECETA
============================================================ */
btnGuardarReceta.onclick = async () => {
  if (!nombreProductoInput.value.trim()) {
    alert("Poné un nombre para la receta");
    return;
  }

  const items = lineas.map(l =>
    l.tipo === "base"
      ? { tipo: "base", nombre: l.nombre, subtotal: l.costo }
      : {
          tipo: "insumo",
          insumoId: l.insumoId,
          nombre: insumos[l.insumoId].nombre,
          cantidad: l.cantidad,
          costoUnit: getCostoUnitarioReal(insumos[l.insumoId]),
          subtotal: l.cantidad * getCostoUnitarioReal(insumos[l.insumoId])
        }
  );

  await addDoc(collection(db, "recetas_borrador"), {
    nombre: nombreProductoInput.value.trim(),
    items,
    costoTotal: items.reduce((a, i) => a + i.subtotal, 0),
    creadaEn: serverTimestamp()
  });

  alert("Receta guardada ✔");
  nombreProductoInput.value = "";
  lineas = [];
  render();
};

/* ============================================================
   INIT
============================================================ */
(async () => {
  await cargarInsumos();
  render();
})();
